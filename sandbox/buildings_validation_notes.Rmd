---
title: "Data Validation Documentation "
author: "Institution Effectiveness"
date: "7/2/2022"
output: html_document
theme: united
new_session: yes
---


# Purpose

The document shows examples and use cases of using the utValidateR package.
See github repository: https://github.com/dsu-effectiveness/utValidateR

### Loading Libraries

```{r echo = FALSE, fig.cap = 'A figure caption.'}
library(utHelpR)
library(utValidateR)
library(tidyverse)
library(gt)

# This function makes the data tables
# This function makes the data tables
mkd_gt_table <- function(df, title, subtitle) {
  gt(df) %>%
  tab_header(
    title = md(title),
    subtitle = md(subtitle)
    ) %>%
  tab_options(
    heading.align = "left",
    table.border.top.color = "white",
    table.border.bottom.color = "white",
    column_labels.border.bottom.color = "white",
    table.align = "left",
    table.width = pct(100),
    data_row.padding = 12
  ) %>%
  cols_align(
    align = "auto",
    columns = everything()
  ) %>%
  tab_style(
    locations = cells_column_labels(columns = everything()),
     style     = list(
       #Give a thick border below
       cell_borders(sides = "bottom", weight = px(3)),
       #Make text bold
       cell_text(weight = "bold")
  )
    )
}
```

### Buildings
- This code pulls the data
```{r echo = FALSE, warning=FALSE}

fake_buildings_df <- (utValidateR::fake_buildings_validation)
real_buildings_df <-(utHelpR::get_data_from_sql_file("buildings_validation.sql", "edify", "sandbox"))

mkd_gt_table(head(fake_buildings_df, 10), "Results: (Fake Data)", "")
mkd_gt_table(head(real_buildings_df, 10), "Results: (Validation Data)", "")
```

#### Checklist contains the validation rules and aux_info shows the valid value comparisons
```{r echo = TRUE, warning=FALSE}
utValidateR::fake_buildings_validation
data("checklist")
data("aux_info")
```

#### Set a variable called building_checks which grabs the database validation rules for buildings
```{r echo = TRUE, warning=FALSE}
building_checks <-filter(checklist, file == "Buildings", type == "Database")
mkd_gt_table(building_checks,"Building Validation Rules:", "")
```

- Run the do_checks function and be sure to pass in the data frame, checks, and aux_info

```{r echo = TRUE, warning=FALSE}
#Run do_checks and product validation results
building_validation_results <- do_checks(real_buildings_df, building_checks, aux_info)
  
mkd_gt_table(head(building_validation_results, 10),"Valiation Results: (Real Data)", "")

results <- building_validation_results %>% 
  select(ends_with("status")) %>% 
  setNames(gsub("_status", "", names(.))) %>% 
  summarize(across(.fns = function(x) mean(x == "Pass"))) %>% 
  pivot_longer(cols = everything(), names_to = "rule", values_to = "pass_rate") %>% 
  arrange(pass_rate) %>% 
  left_join(checklist, by = "rule")
```
